# 项目架构规则（仅非显而易见）

## 关键架构约束

- **文件类型隔离**: 系统有两个独立的数据流：
  - `FileTypeNormal`: 覆盖以前的数据（主流程）
  - `FileTypeAdjustment`: 累加现有数据（次流程）
  - 这两者**不能**在同一处理操作中混合。单独的 API 端点强制执行此规则。

- **中间件顺序依赖**: 认证中间件**必须**在路由组中先于审计中间件。审计中间件从请求中提取用户上下文，而 JWT 中间件注入该上下文。顺序颠倒会破坏审计日志。

- **花名册作为数据增强层**: 花名册**不是**主要数据源。它是 `name` 和 `department` 字段的回退/覆盖层。参见 `processor.go:462-614` 中的 `buildAggregates()`。

- **三阶段处理管道**: 
  1. 解析（Excel → RawRecord）
  2. 聚合（RawRecord → PersonalCharge/UnitCharge）
  3. 导出（Charges → Excel）
  
  阶段 2 是**手动**触发，不是自动的。这是为了数据验证而有意为之。

## 隐藏耦合

- **前端 API 检测**: `getApiBase()` 函数在**模块导入时**运行，创建了对主机名的隐藏依赖。环境变量仅是回退方案，**不是**主要配置方法。

- **数据库类型影响编译**: SQLite 后端在**编译时**需要 CGO + GCC。PostgreSQL 后端不需要。这创建了源代码中不可见的平台特定构建需求。

- **JWT 存储位置**: localStorage 中的令牌在认证系统和浏览器存储 API 之间创建了耦合。服务端渲染无法访问令牌，限制了 SSR 能力。

## 非标准模式

- **启动时自动迁移**: GORM 在每次服务器启动时自动迁移架构。传统迁移系统使用版本化的 SQL 文件。这种方法无法回滚。

- **默认管理员账户**: 系统在首次运行时**无需**用户交互即自动创建特权账户。安全影响：生产部署**必须**立即更改默认密码。

- **Turbopack 作为硬性要求**: 所有前端构建命令都需要 `--turbopack` 标志。这是 Next.js 15 + React 19 兼容性要求，**不是**可选优化。

## 发现的性能瓶颈

- **单线程 Excel 解析**: `ParseSourceFile()` 顺序处理文件。大文件（10k+ 行）会阻塞请求线程。考虑为生产环境添加异步处理队列。

- **每条记录的部门查找**: 在 `buildAggregates()` 中，花名册映射查找针对**每条**原始记录进行。对于 50k 条记录，这成为 O(n) 瓶颈。考虑缓存或索引。

- **前端重新获取所有数据**: 处理后，前端重新加载该期间的**所有**费用。对于大数据集，这会导致 UI 延迟。考虑分页或增量更新。

## 部署陷阱

- **端口映射不对称**: Docker 映射后端 `:8080→:8081` 但前端 `:8080→:10086`。这是为 nginx 反向代理设置而有意为之，**不是**错误。

- **需要卷持久化**: 后端数据在 `backend_data` 卷中。如果删除卷，**所有**期间都会丢失。备份策略**必须**包括 Docker 卷备份。

- **需要 CORS 配置**: 生产环境**必须**设置 `ALLOWED_ORIGINS` 环境变量。默认仅允许 localhost，会破坏生产部署。

## 可扩展性约束

- **SQLite 单写锁**: 默认的 SQLite 无法处理并发写入。对于多用户生产环境，PostgreSQL 是**必需的**，而不是推荐的。

- **没有文件分块**: 大型 Excel 上传会将整个文件加载到内存中。>100MB 的文件可能导致 OOM 错误。考虑为生产环境使用流式解析器。

- **没有后台作业队列**: 所有处理都是同步 HTTP 请求。长时间运行的操作（>30秒）可能超时。考虑为生产规模添加作业队列（Redis/RabbitMQ）。
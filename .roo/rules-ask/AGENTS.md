# 项目文档规则（仅非显而易见）

## 项目结构上下文

- **无根脚本的 Monorepo**: 没有根 `package.json`。所有命令必须从 `frontend/` 或 `backend/` 子目录运行。这是有意为之，**不是**疏忽。
- **CLAUDE.md vs AGENTS.md**: `CLAUDE.md` 包含全面的文档（231 行）。`AGENTS.md` **仅**包含非显而易见的发现。避免重复。
- **后端 "data/" vs "uploads/"**: `data/` 存储 SQLite 数据库；`uploads/` 存储 Excel 文件。两者都被 gitignore 以保护隐私。

## 反直觉的模式

- **文件类型枚举**: `FileType` 字段决定处理模式：
  - `normal`: **覆盖**以前的数据（破坏性）
  - `adjustment`: **累加**现有数据（累加性）
  - 仅从字段名无法看出这一点
- **花名册优先级**: 花名册数据**覆盖**文件数据的 `name` 和 `department` 字段，但**仅当**源文件中这些字段为空时。此回退逻辑在 `buildAggregates()` 中。
- **API 检测逻辑**: 前端在导入时根据主机名自动检测 API URL。环境变量是回退方案，**不是**主要方法。参见 `lib/api.ts` 中的 `getApiBase()`。
- **管理员账户创建**: 系统在首次运行时自动创建 `admin:admin123`。这在 UI 中**未记录**，仅在代码中（`main.go:initializeDefaultAdmin()`）。

## 隐藏需求

- **Windows 开发**: SQLite 在 Windows 上需要 CGO + GCC 编译器。推荐使用 Docker 作为解决方法，**不仅仅是**为了方便。
- **邮箱验证**: 尽管 UI 暗示是可选的，但登录前**必须**验证。后端在 JWT 中间件中强制执行此操作。
- **Turbopack 依赖**: 所有前端命令都需要 `--turbopack` 标志。这**不是**标准的 Next.js 行为。
- **端口映射不匹配**: Docker 后端内部使用 `:8080` 但映射到主机的 `:8081`。前端内部使用 `:8080` 并映射到 `:10086`。这种不对称是为了部署而有意为之。

## 数据流上下文

1. **上传 → 处理 → 导出**: 三步流程是有意设计为手动的。出于数据验证原因，曾考虑但拒绝了自动处理。
2. **调整文件**: 与普通文件分离。可以独立上传并使用 `ProcessAdjustments()` 处理，**不是** `ProcessPeriod()`。
3. **一键花名册导入**: 从数据库中的**任意**期间复制最新花名册。如果任何地方都没有花名册，则回退到手动上传。

## 技术选择上下文

- **Chi 路由器**: 使用它而非 Gin/Echo，因为它的显式路由分组和中间件链。中间件顺序很重要（JWT 在 Audit 之前）。
- **GORM 自动迁移**: 选择它而非手动迁移以实现快速开发。架构更改在启动时自动应用。
- **localStorage 存储 JWT**: 使用它而非 cookies 以简化 CORS 处理。对安全性不理想，但对内部工具可接受。
- **Turbopack 必需**: Next.js 15 配合 React 19 需要 Turbopack 以实现兼容性。标准的 Webpack 构建已损坏。